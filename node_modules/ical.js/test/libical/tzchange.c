/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 * Portions Copyright (C) Philipp Kewisch, 2011-2012 */

#include "libical/ical.h"
#include "libical/icaltimezone.h"
#include <stdio.h>

const char *mytz =
"BEGIN:VTIMEZONE\r\n"
"TZID:Makebelieve/RDATE_as_date\r\n"
"X-LIC-LOCATION:Makebelieve/RDATE_as_date\r\n"
"BEGIN:STANDARD\r\n"
"TZOFFSETFROM:-0400\r\n"
"TZOFFSETTO:-0500\r\n"
"TZNAME:RDATE_as_date_standard\r\n"
"DTSTART:19700101T020000\r\n"
"RDATE:19700101T020000\r\n"
"RDATE;VALUE=DATE:19800101\r\n"
"RDATE:19900101T070000Z\r\n"
"END:STANDARD\r\n"
"BEGIN:DAYLIGHT\r\n"
"TZOFFSETFROM:-0500\r\n"
"TZOFFSETTO:-0400\r\n"
"TZNAME:RDATE_as_date_daylight\r\n"
"DTSTART:19750101T020000\r\n"
"RDATE:19750101T020000\r\n"
"RDATE;VALUE=DATE:19850101\r\n"
"RDATE:19950101T070000Z\r\n"
"END:DAYLIGHT\r\n"
"END:VTIMEZONE";

const char *denvertz =
"BEGIN:VTIMEZONE\r\n" 
"TZID:America/Denver\r\n" 
"BEGIN:DAYLIGHT\r\n" 
"TZOFFSETFROM:-0700\r\n" 
"TZOFFSETTO:-0600\r\n" 
"TZNAME:MDT\r\n" 
"DTSTART:20070311T020000\r\n" 
"RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=2SU\r\n" 
"END:DAYLIGHT\r\n" 
"BEGIN:STANDARD\r\n" 
"TZOFFSETFROM:-0600\r\n" 
"TZOFFSETTO:-0700\r\n" 
"TZNAME:MST\r\n" 
"DTSTART:20071104T020000\r\n" 
"RRULE:FREQ=YEARLY;BYMONTH=11;BYDAY=1SU\r\n" 
"END:STANDARD\r\n" 
"BEGIN:DAYLIGHT\r\n" 
"TZOFFSETFROM:-0700\r\n" 
"TZOFFSETTO:-0600\r\n" 
"TZNAME:MDT\r\n" 
"DTSTART:19180331T020000\r\n" 
"RDATE:20030406T020000\r\n" 
"RDATE:20040404T020000\r\n" 
"RDATE:20050403T020000\r\n" 
"RDATE:20060402T020000\r\n" 
"END:DAYLIGHT\r\n" 
"BEGIN:STANDARD\r\n" 
"TZOFFSETFROM:-0600\r\n" 
"TZOFFSETTO:-0700\r\n" 
"TZNAME:MST\r\n" 
"DTSTART:19181027T020000\r\n" 
"RDATE:20031026T020000\r\n" 
"RDATE:20041031T020000\r\n" 
"RDATE:20051030T020000\r\n" 
"RDATE:20061029T020000\r\n" 
"END:STANDARD\r\n" 
"END:VTIMEZONE";

int main(int argc, char *argv[]) {
    char *dtstr = "20031026T190000";
    icaltimezone *zone;
    struct icaltimetype tt;
    int utc_offset;

    if (argc > 1) {
      dtstr = argv[1];
    }

    icalcomponent *zonecomp = icalcomponent_new_from_string(mytz);
    zone = icaltimezone_new();
    icaltimezone_set_component(zone, zonecomp);
    tt = icaltime_from_string(dtstr);
    icaltime_set_timezone(&tt, zone);

    utc_offset = icaltimezone_get_utc_offset(zone, &tt, NULL);
    printf("OFFSET for %s is %d %p\n", dtstr, utc_offset, zone);
}
